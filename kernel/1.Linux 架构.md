# Linux 架构

:pushpin: 本章节都是基础理论内容，内核本身所涉及的操作内容都是高阶内容，并不会在这演示，有一个基本的认识就好。

操作系统的主要功能是对不同的硬件进行抽象，并为我们提供一个应用编程接口（API）。针对这个 API 的编程允许我们编写应用程序，而不必在意 API 在哪里和如何被执行。简而言之，内核为程序提供了这样一个 API。

在这一章中，我们将讨论什么是 Linux 内核，以及你应该如何把它作为一个整体来考虑，并考虑它的组成部分。你将了解到Linux的整体架构和Linux内核所扮演的重要角色。本章的一个主要收获是，虽然内核提供了所有的核心功能，但它本身并不是操作系统，而只是操作系统的一部分，当然是非常核心的部分。

首先，我们看看内核是如何融入底层硬件并与之互动的。然后，讨论不同的 CPU 架构以及它们与内核的关系。接下来，我们放大各个内核组件，讨论内核为你可以运行的程序提供的 API。最后，我们看一下如何定制和扩展Linux内核。

本章的目的是让你掌握必要的术语，让你了解程序和内核之间的接口，并让你对功能有一个基本的概念。本章的目的不是要把你变成一个内核开发者，甚至是一个配置和编译内核的系统管理员。不过，如果你想深入了解，我在最后整理了一些要点。

现在，让我们跳入深渊：Linux体系结构，以及内核在其中扮演的核心角色。

![image-20220418025400055](../images/image-20220418025400055.png)

我们将整个系统分为三层，从下往上是：

- 硬件：CPU、内存、磁盘驱动器、网络接口和外围设备，如键盘和显示器。

- 内核本身，请注意，有许多组件位于内核和用户平台之间，例如初始化系统和系统服务（网络等），但严格来说，它们不是内核的一部分。

- 用户层：大多数应用程序正在运行的地方，包括操作系统组件，如shell（在第3章中讨论），ps 或 ssh 等实用程序，以及图形用户界面，如基于X Window的系统桌面。

不同层之间的接口被很好地定义了，是Linux操作系统包的一部分。在内核和用户地之间的接口被称为系统调用（简称syscalls），我们将在 "Syscalls "中详细探讨。

与系统调用不同，硬件和内核之间的接口不是单个接口。它由单个接口的集合组成，通常按硬件分组：

1. 此接口由 CPU 架构特定的代码表示，在后面我们会聊到 "CPU 架构"。
2. 主内存的接口，在"内存管理"中介绍。
3. 网络接口和驱动程序（有线和无线），这部分内容会在网络一节中详细解释。
4. 文件系统和块设备驱动程序接口，这部分内容会在文件系统一节中详细解释。
5. 字符设备、硬件中断和设备驱动程序，用于输入设备，如键盘、终端和其他 I/O（"设备驱动程序"）。

正如上图所示， shell 或 grep、find 和 ping 等工具并不是内核的一部分，而是非常像一个应用程序，是用户空间的一部分。

关于 "用户空间 "的话题：你会经常读到或听到关于用户与内核模式。这实际上意味着对硬件的访问有多大的特权，可用的抽象有多大的限制。

一般来说，内核模式（kernel mode）意味着在有限的抽象下快速执行，而用户级空间（user level land）模式意味着相对较慢但更安全和更方便的抽象。除非你是一个内核开发者，否则你几乎总是可以忽略内核模式，因为你所有的应用程序都会在用户级空间运行。另一方面，知道如何与内核交互（"Syscalls"）是至关重要的，也是我们考虑的一部分。
